<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#050510">
    
    <title>NEXUS</title>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;600;700;800&family=Outfit:wght@200;400;700&display=swap" rel="stylesheet">
    
    <style>
        /* --- 1. RESET Y BASE --- */
        *:not(input) { 
            margin: 0; padding: 0; box-sizing: border-box; outline: none; 
            -webkit-tap-highlight-color: transparent;
            -webkit-user-select: none; user-select: none; -webkit-user-drag: none;
        }
        
        input:focus { outline: none; }
        button:focus { outline: none; } /* Importante: Evita que el botón se quede "seleccionado" */

        :root {
            --neon-blue: #00f3ff;
            --neon-purple: #bc13fe;
            --bg-dark: #050510;
            --glass: rgba(20, 20, 30, 0.7);
            --glass-border: rgba(255, 255, 255, 0.15);
            --fb-color: #1877F2;
        }
        
        body {
            background-color: var(--bg-dark);
            font-family: 'Outfit', sans-serif;
            color: white;
            overflow-x: hidden;
            height: 100vh;
            cursor: default;
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
        }

        /* Clase para bloquear scroll cuando el player está activo */
        body.lock-scroll { overflow: hidden !important; width: 100%; height: 100%; position: fixed; }

        #bg-canvas { position: fixed; inset: 0; z-index: -1; background: radial-gradient(circle at center, #151520 0%, #000 100%); }

        /* --- 2. SPLASH SCREEN --- */
        #splash {
            position: fixed; inset: 0; background: #000; z-index: 10000;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            transition: opacity 1s ease, visibility 1s;
            padding: 20px;
        }
        #splash.hidden { opacity: 0; visibility: hidden; pointer-events: none; }

        .splash-logo {
            font-family: 'Rajdhani', sans-serif; font-size: 5rem; font-weight: 800;
            letter-spacing: 10px; color: transparent;
            -webkit-text-stroke: 2px var(--neon-blue);
            text-shadow: 0 0 50px var(--neon-blue);
            animation: logoReveal 4s cubic-bezier(0.2, 0.8, 0.2, 1) forwards;
            text-align: center;
        }
        
        .splash-sub {
            font-size: 1.1rem; letter-spacing: 6px; color: var(--neon-purple);
            text-transform: uppercase; margin-top: 20px; opacity: 0;
            animation: slideUp 1.5s 1.5s forwards;
            text-align: center; width: 100%; line-height: 1.5;
        }

        /* --- 3. UI PRINCIPAL --- */
        #app {
            max-width: 1400px; margin: 0 auto; padding: 20px;
            opacity: 0; transform: scale(0.98); 
            transition: opacity 1s ease, transform 1s ease;
            padding-bottom: 80px; 
        }
        .visible { opacity: 1 !important; transform: scale(1) !important; }

        header {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            padding: 60px 10px 20px 10px; margin-bottom: 20px; gap: 15px;
        }

        /* RELOJ */
        .digital-clock-container { display: flex; flex-direction: column; align-items: center; margin-bottom: 5px; filter: drop-shadow(0 0 10px rgba(0, 243, 255, 0.2)); }
        .clock-time-wrapper { font-family: 'Rajdhani', sans-serif; font-size: 3rem; font-weight: 700; color: white; line-height: 1; display: flex; align-items: baseline; gap: 5px; }
        .clock-ampm { font-size: 1.2rem; color: var(--neon-purple); font-weight: 600; }
        .clock-date { font-family: 'Outfit', sans-serif; font-size: 0.85rem; color: rgba(255, 255, 255, 0.5); letter-spacing: 2px; text-transform: uppercase; margin-top: 5px; }

        /* MARCA */
        .brand {
            font-family: 'Rajdhani', sans-serif; font-size: 2.5rem; font-weight: 800;
            background: linear-gradient(90deg, var(--neon-blue), var(--neon-purple));
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            filter: drop-shadow(0 0 15px rgba(0, 243, 255, 0.3));
            letter-spacing: 5px; pointer-events: none; margin-bottom: 10px;
        }

        /* BUSCADOR CON BOTÓN X */
        .search-container { width: 100%; display: flex; justify-content: center; z-index: 200; }
        .search-box {
            position: relative; width: 100%; max-width: 450px;
            background: rgba(0, 0, 0, 0.5); border: 1px solid var(--glass-border);
            border-radius: 50px; padding: 10px 20px 10px 25px;
            display: flex; align-items: center; transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        .search-box:focus-within { background: rgba(0,0,0,0.9); border-color: var(--neon-blue); box-shadow: 0 0 25px rgba(0, 243, 255, 0.15); transform: scale(1.02); }
        .search-input {
            background: transparent; border: none; color: white;
            font-family: 'Rajdhani', sans-serif; font-size: 1.2rem; 
            letter-spacing: 1px; width: 100%; font-weight: 500;
            user-select: text; -webkit-user-select: text;
        }
        .search-input::placeholder { color: rgba(255,255,255,0.3); font-size: 1rem; }
        .search-icon { color: var(--neon-purple); font-size: 1.2rem; margin-right: 15px; }
        .search-clear {
            background: transparent; border: none; color: var(--neon-blue);
            font-size: 1.2rem; cursor: pointer; padding: 5px; margin-left: 5px;
            display: none; align-items: center; justify-content: center;
        }

        /* --- BOTONES NAV (DISEÑO LIMPIO) --- */
        .nav-btn {
            position: fixed; top: 30px; z-index: 9000;
            width: 45px; height: 45px; border-radius: 50%;
            font-size: 1.2rem; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            transition: transform 0.2s, background 0.2s;
            backdrop-filter: blur(10px);
            box-shadow: 0 0 15px rgba(0,0,0,0.5);
            pointer-events: auto;
            touch-action: manipulation; /* Optimización táctil */
        }

        #btn-refresh {
            background: rgba(0,0,0,0.6); border: 2px solid var(--neon-blue); color: var(--neon-blue);
            right: 20px;
        }
        
        #btn-back {
            background: rgba(0,0,0,0.8); border: 2px solid var(--neon-purple); color: var(--neon-purple);
            right: -100px; opacity: 0; pointer-events: none; transition: right 0.3s ease, opacity 0.3s ease;
        }
        #btn-back.show-btn { right: 20px; opacity: 1; pointer-events: auto; }

        /* Efectos visuales */
        #btn-refresh:active, #btn-back:active { transform: scale(0.9); background: rgba(255,255,255,0.1); }

        /* --- GRID --- */
        .grid-container { display: grid; gap: 15px; padding-bottom: 20px; }
        .countries-mode { grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); }
        .channels-mode { grid-template-columns: repeat(3, 1fr) !important; gap: 10px; }

        .card {
            position: relative; border-radius: 12px;
            background: var(--glass); border: 1px solid var(--glass-border);
            cursor: pointer; transform-style: preserve-3d;
            opacity: 0; transform: translateY(20px);
            transition: transform 0.3s, border-color 0.3s;
            overflow: hidden; box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        .card.show { animation: cardEntrance 0.5s forwards; }
        .aspect-rect { aspect-ratio: 2/3; }
        .aspect-square { aspect-ratio: 1/1; }
        .card:hover { border-color: var(--neon-blue); }
        .card:active { transform: scale(0.95); } /* Feedback táctil */
        
        .card-inner { position: relative; width: 100%; height: 100%; pointer-events: none; }
        .card-img { width: 100%; height: 100%; object-fit: cover; filter: brightness(0.9); }
        .card-img.channel-logo { object-fit: contain !important; transform: scale(0.9); background: rgba(0,0,0,0.3); }
        .card-title-bar {
            position: absolute; bottom: 0; left: 0; width: 100%;
            background: rgba(5, 5, 10, 0.95); border-top: 1px solid var(--neon-blue);
            padding: 6px 2px; z-index: 2; display: flex; align-items: center; justify-content: center;
        }
        .card-title {
            font-family: 'Rajdhani', sans-serif; font-size: 0.7rem; font-weight: 700; text-transform: uppercase;
            color: var(--neon-blue); text-align: center; letter-spacing: 1px;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis; width: 100%;
        }

        /* --- PLAYER --- */
        #player-modal {
            position: fixed; inset: 0; background: black; z-index: 10000;
            display: none; justify-content: center; align-items: center;
            animation: fadeIn 0.3s ease;
        }
        
        .video-container {
            width: 100%; max-width: 1200px; position: relative;
            padding-bottom: 56.25%; height: 0; overflow: hidden;
            background: #000; border: 1px solid #333;
            display: flex; justify-content: center; align-items: center;
        }

        /* Landscape Handling */
        @media (orientation: landscape) {
            header, #grid, .fb-btn-container, #btn-refresh, #btn-back { display: none !important; }
            .close-player { display: none !important; }
            
            .video-container {
                position: fixed !important; top: 0 !important; left: 0 !important;
                width: 100vw !important; height: 100vh !important;
                max-width: none !important; padding-bottom: 0 !important;
                z-index: 99999 !important; background: black !important;
                display: flex !important; justify-content: center !important; align-items: center !important;
            }
            video, iframe {
                width: 100% !important; height: 100% !important;
                max-width: 100vw !important; max-height: 100vh !important;
                object-fit: contain !important; position: static !important;
            }
            #video-slot { position: static !important; width: 100% !important; height: 100% !important; display: flex; justify-content: center; align-items: center; }
        }

        #video-slot { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        video, iframe { width: 100%; height: 100%; position: absolute; top: 0; left: 0; border: none; display: block; }

        /* Capa táctil para controles */
        #click-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 20; display: none; }
        .controls-hidden #click-layer { display: block; }

        /* Controles */
        .pro-controls {
            position: absolute; bottom: 0; left: 0; right: 0; height: 60px;
            background: linear-gradient(to top, rgba(0,0,0,0.95), transparent);
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 20px; opacity: 1; transition: opacity 0.5s ease; z-index: 2147483647; 
        }
        .controls-hidden .pro-controls { opacity: 0; pointer-events: none; }
        .controls-left, .controls-right { display: flex; align-items: center; gap: 15px; }
        
        .icon-btn {
            background: none; border: none; cursor: pointer; color: rgba(255,255,255,0.85);
            width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; transition: 0.2s;
        }
        .icon-btn svg { width: 24px; height: 24px; fill: currentColor; }
        .live-badge { background: #cc0000; color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.7rem; font-weight: 700; margin-right: 10px; cursor: pointer; }
        .channel-info { font-size: 0.9rem; font-weight: 500; color: #ddd; }
        
        .close-player {
            position: absolute; top: 15px; right: 15px; z-index: 2147483647;
            background: rgba(0,0,0,0.5); width: 40px; height: 40px; border-radius: 50%;
            border: none; color: white; cursor: pointer; display: grid; place-items: center;
            opacity: 1; transition: opacity 0.5s ease;
        }
        .controls-hidden .close-player { opacity: 0; pointer-events: none; }

        /* Facebook */
        .fb-btn-container { width: 100%; display: flex; justify-content: center; margin-top: 30px; margin-bottom: 20px; padding-bottom: 20px; }
        .btn-facebook-stealth {
            width: 40px; height: 40px; background: rgba(255, 255, 255, 0.05); border-radius: 50%;
            display: flex; align-items: center; justify-content: center; transition: all 0.3s ease;
            backdrop-filter: blur(2px); border: 1px solid rgba(255, 255, 255, 0.05);
        }
        .btn-facebook-stealth svg { width: 20px; height: 20px; fill: rgba(255, 255, 255, 0.2); transition: 0.3s; }
        .btn-facebook-stealth:active { background: var(--fb-color); box-shadow: 0 0 15px var(--fb-color); }
        .btn-facebook-stealth:active svg { fill: white; }

        @keyframes logoReveal { 0% { opacity: 0; letter-spacing: 30px; filter: blur(20px); } 50% { opacity: 1; filter: blur(0px); } 100% { letter-spacing: 15px; } }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes cardEntrance { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body oncontextmenu="return false" ondragstart="return false" onselectstart="return false">

    <canvas id="bg-canvas"></canvas>

    <div id="splash">
        <h1 class="splash-logo">NEXUS</h1>
        <p class="splash-sub">Centroamérica Conectada</p>
    </div>

    <button id="btn-refresh" class="nav-btn" onmousedown="sound('click'); location.reload()" title="Actualizar">↻</button>
    
    <button id="btn-back" class="nav-btn" onmousedown="event.preventDefault(); goBackSystem()" title="Regresar">❮</button>

    <div id="app">
        <header>
            <div class="digital-clock-container">
                <div class="clock-time-wrapper">
                    <span id="clock-time">00:00</span>
                    <span id="clock-ampm" class="clock-ampm">AM</span>
                </div>
                <div id="clock-date" class="clock-date">Cargando...</div>
            </div>

            <div class="brand">NEXUS</div>
            
            <div class="search-container">
                <div class="search-box">
                    <span class="search-icon">⌕</span>
                    <input type="text" id="search-input" class="search-input" placeholder="BUSCAR..." autocomplete="off">
                    <button class="search-clear" id="btn-clear-search" onmousedown="event.preventDefault(); clearSearch()">✕</button>
                </div>
            </div>
        </header>

        <h3 id="section-title" style="margin-bottom: 20px; text-align: center; font-weight: 300; opacity: 0.8; letter-spacing: 2px;">EXPLORAR REGIONES</h3>
        <div id="grid" class="grid-container countries-mode"></div>

        <div class="fb-btn-container">
            <a href="https://www.facebook.com" target="_blank" class="btn-facebook-stealth" onclick="sound('click')">
                <svg viewBox="0 0 24 24"><path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/></svg>
            </a>
        </div>
    </div>

    <div id="player-modal">
        <div class="video-container" id="vid-container" onmousemove="resetControlsTimer()">
            <div id="click-layer" onclick="resetControlsTimer()"></div>
            <button class="close-player" onclick="smartClose()">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18M6 6l12 12"/></svg>
            </button>
            <div id="video-slot"></div>
            <div class="pro-controls" id="controls">
                <div class="controls-left">
                    <button class="icon-btn" onclick="togglePlay()" id="btn-play"><svg viewBox="0 0 24 24"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg></button>
                    <button class="icon-btn" onclick="toggleMute()" id="btn-mute"><svg viewBox="0 0 24 24"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02z"/></svg></button>
                    <div class="live-badge" onclick="sound('click'); refreshStream();" title="Recargar transmisión">EN VIVO</div>
                    <span class="channel-info" id="playing-name">Canal</span>
                </div>
                <div class="controls-right">
                    <button class="icon-btn" onclick="toggleFullScreen()"><svg viewBox="0 0 24 24"><path d="M7 14H5v5h5v-2H7v-3zm-2-4h2V7h3V5H5v5zm12 7h-3v2h5v-5h-2v3zM14 5v2h3v3h2V5h-5z"/></svg></button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- VARIABLES DE ESTADO ---
        // ESTA ES LA CLAVE: SABER DONDE ESTAMOS SIEMPRE
        let appState = 'HOME'; // Valores: 'HOME', 'CHANNELS', 'PLAYER'
        let currentCountry = null;
        let currentChannel = null;
        let hls = null;
        let controlsTimeout;
        let searchTimeout;

        // --- SISTEMA DE AUDIO ---
        const SFX = {
            click: new Audio('https://assets.mixkit.co/active_storage/sfx/2571/2571-preview.mp3'),
            select: new Audio('https://assets.mixkit.co/active_storage/sfx/2568/2568-preview.mp3'),
            back: new Audio('https://assets.mixkit.co/active_storage/sfx/2572/2572-preview.mp3')
        };
        function sound(type) { 
            const s = SFX[type].cloneNode(); s.volume = 0.5; s.play().catch(()=>{}); 
        }

        // --- DATA ---
        const DATA = [
            { id: 'gt', name: 'HONDURAS', img: 'https://actionflag.com/cdn/shop/products/honduras-nylon-outdoor-flag-5502568.webp?v=1752896885', channels: [
                { name: 'CANAL 10', img: 'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQpDGlXC04QvxP1Y__Sas5hW2iXoSDiPwCdcP1AuKneTQ&s=10', url: 'https://gavamultimedios.com/CHTV/index.php' },
                { name: 'CANAL 11', img: 'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQfLY40-OiueBodErw2tgVrSCuwVxJqHFAM-pmCUYcs9Q&s=10', url: 'https://redirector.rudo.video/hls-video/c54ac2799874375c81c1672abb700870537c5223/canal11hn/canal11hn.smil/playlist.m3u8?did=b2141583316068ca2593ea08a' },
                { name: 'METRO TV', img: 'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSgu9VRA7NBDrkAuMghiTBdr4kQ-m0IqlSwtr2uXXuOqg&s=10', url: 'https://s.emisoras.tv:8081/metrotv/index.m3u8' },
                { name: 'ALSIASTV', img: 'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSu3z5fYrtvbiB8i-lxiEppQikxSPNEczB9KuJzjKsx0w&s=10', url: 'https://s.emisoras.tv:8081/atv/index.m3u8' },
                { name: 'ALSIASTV', img: 'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSu3z5fYrtvbiB8i-lxiEppQikxSPNEczB9KuJzjKsx0w&s=10', url: 'https://s.emisoras.tv:8081/atv/index.m3u8' },
                { name: 'ALSIASTV', img: 'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSu3z5fYrtvbiB8i-lxiEppQikxSPNEczB9KuJzjKsx0w&s=10', url: 'https://s.emisoras.tv:8081/atv/index.m3u8' },
                { name: 'ALSIASTV', img: 'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSu3z5fYrtvbiB8i-lxiEppQikxSPNEczB9KuJzjKsx0w&s=10', url: 'https://s.emisoras.tv:8081/atv/index.m3u8' },
                { name: 'ALSIASTV', img: 'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSu3z5fYrtvbiB8i-lxiEppQikxSPNEczB9KuJzjKsx0w&s=10', url: 'https://s.emisoras.tv:8081/atv/index.m3u8' }
            ]},
            { id: 'hn', name: 'Honduras', img: 'https://images.unsplash.com/photo-1588612509890-7c56972e257a?w=400&q=80', channels: [
                { name: 'HCH', img: 'https://placehold.co/200x200/222/fff?text=HCH', url: '#' },
                { name: 'TVC', img: 'https://placehold.co/200x200/222/fff?text=TVC', url: '#' },
                { name: 'Canal 11', img: 'https://placehold.co/200x200/222/fff?text=11', url: '#' }
            ]},
            { id: 'sv', name: 'El Salvador', img: 'https://images.unsplash.com/photo-1627920769919-482065979207?w=400&q=80', channels: [
                { name: 'TCS', img: 'https://placehold.co/200x200/222/fff?text=TCS', url: '#' },
                { name: 'Canal 12', img: 'https://placehold.co/200x200/222/fff?text=12', url: '#' }
            ]},
            { id: 'cr', name: 'Costa Rica', img: 'https://images.unsplash.com/photo-1518182170546-0766ce6fec56?w=400&q=80', channels: [
                { name: 'Teletica', img: 'https://placehold.co/200x200/222/fff?text=7', url: '#' },
                { name: 'Repretel', img: 'https://placehold.co/200x200/222/fff?text=6', url: '#' }
            ]},
            { id: 'ni', name: 'Nicaragua', img: 'https://images.unsplash.com/photo-1569408016462-113c23315a63?w=400&q=80', channels: [
                { name: 'Canal 10', img: 'https://placehold.co/200x200/222/fff?text=10', url: '#' },
                { name: 'Canal 4', img: 'https://placehold.co/200x200/222/fff?text=4', url: '#' }
            ]},
            { id: 'pa', name: 'Panamá', img: 'https://images.unsplash.com/photo-1502307134371-d6402432a51a?w=400&q=80', channels: [
                { name: 'TVN', img: 'https://placehold.co/200x200/222/fff?text=TVN', url: '#' },
                { name: 'Telemetro', img: 'https://placehold.co/200x200/222/fff?text=TM', url: '#' }
            ]}
        ];

        // --- ELEMENTOS DOM ---
        const grid = document.getElementById('grid');
        const title = document.getElementById('section-title');
        const search = document.getElementById('search-input');
        const btnRefresh = document.getElementById('btn-refresh');
        const btnBack = document.getElementById('btn-back');
        const btnClear = document.getElementById('btn-clear-search');
        const splash = document.getElementById('splash');
        const app = document.getElementById('app');

        // --- INIT ---
        window.onload = () => {
            updateClock();
            setInterval(updateClock, 1000);
            setTimeout(() => { 
                splash.classList.add('hidden'); 
                app.classList.add('visible'); 
                renderCountries(); 
            }, 3000); 
        };

        // --- RELOJ ---
        function updateClock() {
            const now = new Date();
            let h = now.getHours();
            const m = String(now.getMinutes()).padStart(2, '0');
            const ampm = h >= 12 ? 'PM' : 'AM';
            h = h % 12; h = h ? h : 12; 
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('clock-time').textContent = `${h}:${m}`;
            document.getElementById('clock-ampm').textContent = ampm;
            document.getElementById('clock-date').textContent = now.toLocaleDateString('es-ES', options);
        }

        // --- FUNCIONES DE NAVEGACIÓN Y RENDERIZADO ---
        
        // 1. Mostrar Países (HOME)
        function renderCountries(d = DATA) {
            appState = 'HOME'; // ESTADO ACTUAL
            currentCountry = null;
            
            grid.className = 'grid-container countries-mode'; 
            grid.innerHTML = ''; 
            title.innerText = 'EXPLORAR REGIONES'; 
            
            // Ocultar botón de regresar en Home
            btnBack.classList.remove('show-btn');
            btnRefresh.classList.remove('move-left');
            
            if(d.length === 0) {
                grid.innerHTML = '<div style="text-align:center;width:100%;padding:20px;opacity:0.5">Sin resultados</div>';
                return;
            }

            d.forEach((c, i) => { 
                const el = createCard(c.name, c.img, 'aspect-rect', i, false); 
                el.onclick = () => { 
                    sound('select'); 
                    search.value = ''; // Limpiar búsqueda al entrar
                    btnClear.style.display = 'none';
                    renderChannels(c); 
                }; 
                grid.appendChild(el); 
            });
        }

        // 2. Mostrar Canales (CHANNELS)
        function renderChannels(country, d = null) {
            appState = 'CHANNELS'; // ESTADO ACTUAL
            currentCountry = country;
            
            const channels = d || country.channels;
            grid.innerHTML = ''; 
            grid.style.opacity = 0;
            
            setTimeout(() => {
                grid.className = 'grid-container channels-mode'; 
                title.innerText = country.name; 
                
                // Mostrar botón de regresar
                btnBack.classList.add('show-btn'); 
                btnRefresh.classList.add('move-left');     
                
                if(channels.length === 0) {
                    grid.innerHTML = '<div style="text-align:center;width:100%;padding:20px;opacity:0.5">Sin resultados</div>';
                } else {
                    channels.forEach((c, i) => { 
                        const el = createCard(c.name, c.img, 'aspect-square', i, true); 
                        el.onclick = () => { 
                            sound('select'); 
                            openPlayer(c); 
                        }; 
                        grid.appendChild(el); 
                    });
                }
                grid.style.opacity = 1;
            }, 100);
        }

        function createCard(txt, img, ratio, index, isChannel) {
            const d = document.createElement('div'); d.className = `card ${ratio}`; d.style.animationDelay = `${index * 0.05}s`;
            const imgClass = isChannel ? "card-img channel-logo" : "card-img";
            d.innerHTML = `<div class="card-inner"><img src="${img}" class="${imgClass}" loading="lazy"><div class="card-title-bar"><div class="card-title">${txt}</div></div></div>`;
            setTimeout(() => d.classList.add('show'), 10);
            return d;
        }

        // --- SISTEMA DE BÚSQUEDA ---
        const normalizeText = (text) => text.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase();

        search.addEventListener('input', (e) => {
            const val = e.target.value;
            btnClear.style.display = val.length > 0 ? 'flex' : 'none';

            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                const normVal = normalizeText(val);
                if(appState === 'HOME') {
                    renderCountries(DATA.filter(c => normalizeText(c.name).includes(normVal))); 
                } else if (appState === 'CHANNELS' && currentCountry) {
                    renderChannels(currentCountry, currentCountry.channels.filter(c => normalizeText(c.name).includes(normVal))); 
                }
            }, 300); 
        });

        function clearSearch() {
            sound('click');
            search.value = '';
            btnClear.style.display = 'none';
            if(document.activeElement) document.activeElement.blur(); // Cerrar teclado
            
            // Restaurar vista actual
            if(appState === 'HOME') renderCountries();
            else if(appState === 'CHANNELS') renderChannels(currentCountry);
        }

        // --- BOTÓN REGRESAR MAESTRO (NUEVO) ---
        function goBackSystem() {
            sound('back');
            const btn = document.getElementById('btn-back');
            if(btn) btn.blur(); // Quitar foco inmediatamente

            if(appState === 'PLAYER') {
                smartClose(); // Cerrar video
            } 
            else if(appState === 'CHANNELS') {
                renderCountries(); // Ir a Países
            } 
            else if(appState === 'HOME') {
                history.back(); // Salir de la app
            }
        }

        // --- PLAYER LOGIC ---
        function openPlayer(c) {
            appState = 'PLAYER'; // ESTADO ACTUAL
            document.body.classList.add('player-active'); 
            currentChannel = c; 
            
            const p = document.getElementById('player-modal'); const s = document.getElementById('video-slot'); const ctrls = document.getElementById('controls');
            document.getElementById('playing-name').innerText = c.name; p.style.display = 'flex'; s.innerHTML = '';
            document.getElementById('btn-mute').innerHTML = `<svg viewBox="0 0 24 24"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02z"/></svg>`;
            
            resetControlsTimer();

            if(c.url.includes('.m3u8')) {
                ctrls.style.display = 'flex';
                document.querySelector('.controls-left').style.display = 'flex';
                const v = document.createElement('video'); v.id = 'vid'; v.autoplay = true; s.appendChild(v); ctrls.style.display = 'flex';
                document.getElementById('btn-play').innerHTML = `<svg viewBox="0 0 24 24"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>`;
                if(Hls.isSupported()) { hls = new Hls(); hls.loadSource(c.url); hls.attachMedia(v); } 
                else if(v.canPlayType('application/vnd.apple.mpegurl')) v.src = c.url;
            } else {
                ctrls.style.display = 'none'; 
                s.innerHTML = `<iframe src="${c.url}" sandbox="allow-scripts allow-same-origin allow-presentation" allowfullscreen allow="autoplay; encrypted-media"></iframe>`; 
            }
        }

        async function smartClose() { 
            // Cerrar player y volver a canales
            const isVisuallyLandscape = window.innerWidth > window.innerHeight;
            
            // Función de limpieza
            const cleanup = () => {
                document.body.classList.remove('player-active');
                if(controlsTimeout) clearTimeout(controlsTimeout);
                document.getElementById('player-modal').style.display = 'none'; 
                document.getElementById('video-slot').innerHTML = ''; 
                if(hls) { hls.destroy(); hls = null; }
                
                // RESTAURAR ESTADO
                if(currentCountry) {
                    appState = 'CHANNELS';
                } else {
                    appState = 'HOME';
                }
            };

            if (isVisuallyLandscape) {
                try {
                    if (document.exitFullscreen) await document.exitFullscreen();
                    else if (document.webkitExitFullscreen) await document.webkitExitFullscreen();
                    if (screen.orientation && screen.orientation.unlock) screen.orientation.unlock();
                } catch(e) {}
                cleanup(); // Cerrar de todas formas
            } else {
                try {
                    if (document.fullscreenElement) {
                        if (document.exitFullscreen) await document.exitFullscreen();
                        else if (document.webkitExitFullscreen) await document.webkitExitFullscreen();
                    }
                } catch(e) {}
                cleanup();
            }
        }

        function resetControlsTimer() {
            const container = document.querySelector('.video-container');
            container.classList.remove('controls-hidden');
            if(controlsTimeout) clearTimeout(controlsTimeout);
            controlsTimeout = setTimeout(() => { container.classList.add('controls-hidden'); }, 3000);
        }

        function refreshStream() {
            if(hls && currentChannel) {
                hls.loadSource(currentChannel.url);
                const v = document.getElementById('vid');
                if(v) v.play();
                document.getElementById('btn-play').innerHTML = `<svg viewBox="0 0 24 24"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>`;
            }
        }

        function togglePlay() { 
            sound('click'); document.getElementById('btn-play').blur(); resetControlsTimer();
            const v=document.getElementById('vid'); const b=document.getElementById('btn-play'); 
            if(v){ 
                if(v.paused){ v.play(); b.innerHTML=`<svg viewBox="0 0 24 24"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>`; } 
                else { v.pause(); b.innerHTML=`<svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>`; } 
            } 
        }
        
        function toggleMute() { 
            sound('click'); document.getElementById('btn-mute').blur(); resetControlsTimer();
            const v=document.getElementById('vid'); const b=document.getElementById('btn-mute');
            if(v) {
                v.muted = !v.muted;
                if(v.muted) b.innerHTML = `<svg viewBox="0 0 24 24"><path d="M16.5 12c0-1.77-1.02-3.29-2.5-4.03v2.21l2.45 2.45c.03-.2.05-.41.05-.63zm2.5 0c0 .94-.2 1.82-.54 2.64l1.51 1.51C20.63 14.91 21 13.5 21 12c0-4.28-2.99-7.86-7-8.77v2.06c2.89.86 5 3.54 5 6.71zM4.27 3L3 4.27 7.73 9H3v6h4l5 5v-6.73l4.25 4.25c-.67.52-1.42.93-2.25 1.18v2.06c1.38-.31 2.63-.95 3.69-1.81L19.73 21 21 19.73 4.27 3zM12 4L9.91 6.09 12 8.18V4z"/></svg>`; 
                else b.innerHTML = `<svg viewBox="0 0 24 24"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02z"/></svg>`; 
            }
        }
        
        async function toggleFullScreen() {
            sound('click'); if(document.activeElement) document.activeElement.blur();
            const el = document.querySelector('.video-container');
            if (document.fullscreenElement) {
                if (document.exitFullscreen) await document.exitFullscreen();
                if (screen.orientation && screen.orientation.unlock) screen.orientation.unlock();
            } else {
                try {
                    if (el.requestFullscreen) await el.requestFullscreen();
                    else if (el.webkitRequestFullscreen) await el.webkitRequestFullscreen();
                    if (screen.orientation && screen.orientation.lock) await screen.orientation.lock('landscape');
                } catch (e) {}
            }
        }
        
        const canvas = document.getElementById('bg-canvas'); const ctx = canvas.getContext('2d'); let parts = [];
        const resize = () => { canvas.width = innerWidth; canvas.height = innerHeight; }; window.onresize = resize; resize();
        class P { constructor() { this.r(); } r() { this.x=Math.random()*canvas.width; this.y=Math.random()*canvas.height; this.vx=(Math.random()-.5)*.5; this.vy=(Math.random()-.5)*.5; } u() { this.x+=this.vx; this.y+=this.vy; if(this.x<0||this.x>canvas.width)this.vx*=-1; if(this.y<0||this.y>canvas.height)this.vy*=-1; } d() { ctx.fillStyle='rgba(0,243,255,0.2)'; ctx.beginPath(); ctx.arc(this.x,this.y,Math.random()*2,0,Math.PI*2); ctx.fill(); } }
        for(let i=0;i<60;i++) parts.push(new P());
        function anim() { ctx.clearRect(0,0,canvas.width,canvas.height); parts.forEach(p=>{p.u();p.d();}); requestAnimationFrame(anim); }
    </script>
</body>
</html>
