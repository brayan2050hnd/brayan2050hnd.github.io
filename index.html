<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#050510">
    
    <title>NEXUS</title>
    
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <script src="https://www.gstatic.com/cv/js/sender/v1/cast_sender.js?loadCastFramework=1"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;600;700;800&family=Outfit:wght@200;400;700&display=swap" rel="stylesheet">
    
    <style>
        /* --- ESTILOS VISUALES (TU DISEÑO ORIGINAL) --- */
        *:not(input) { margin: 0; padding: 0; box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; -webkit-user-select: none; user-select: none; -webkit-user-drag: none; }
        input:focus { outline: none; }
        button:focus { outline: none; }

        :root { --neon-blue: #00f3ff; --neon-purple: #bc13fe; --bg-dark: #050510; --glass: rgba(20, 20, 30, 0.7); --glass-border: rgba(255, 255, 255, 0.15); }
        
        body { background-color: var(--bg-dark); font-family: 'Outfit', sans-serif; color: white; overflow-x: hidden; height: 100vh; padding-top: env(safe-area-inset-top); padding-bottom: env(safe-area-inset-bottom); }
        body.player-active { overflow: hidden !important; position: fixed; width: 100%; height: 100%; }
        #bg-canvas { position: fixed; inset: 0; z-index: -1; background: radial-gradient(circle at center, #151520 0%, #000 100%); }

        /* SPLASH */
        #splash { position: fixed; inset: 0; background: #000; z-index: 10000; display: flex; flex-direction: column; justify-content: center; align-items: center; transition: opacity 1s ease, visibility 1s; padding: 20px; }
        #splash.hidden { opacity: 0; visibility: hidden; pointer-events: none; }
        .splash-logo { font-family: 'Rajdhani', sans-serif; font-size: 5rem; font-weight: 800; letter-spacing: 10px; color: transparent; -webkit-text-stroke: 2px var(--neon-blue); text-shadow: 0 0 50px var(--neon-blue); animation: logoReveal 4s cubic-bezier(0.2, 0.8, 0.2, 1) forwards; text-align: center; }
        .splash-sub { font-size: 1.1rem; letter-spacing: 6px; color: var(--neon-purple); text-transform: uppercase; margin-top: 20px; opacity: 0; animation: slideUp 1.5s 1.5s forwards; text-align: center; width: 100%; line-height: 1.5; }

        /* INTERFAZ */
        #app { max-width: 1400px; margin: 0 auto; padding: 20px; opacity: 0; transform: scale(0.98); transition: opacity 1s ease, transform 1s ease; padding-bottom: 80px; }
        .visible { opacity: 1 !important; transform: scale(1) !important; }
        header { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 60px 10px 20px 10px; margin-bottom: 20px; gap: 15px; }
        
        .digital-clock-container { display: flex; flex-direction: column; align-items: center; margin-bottom: 5px; filter: drop-shadow(0 0 10px rgba(0, 243, 255, 0.2)); }
        .clock-time-wrapper { font-family: 'Rajdhani', sans-serif; font-size: 3rem; font-weight: 700; color: white; line-height: 1; display: flex; align-items: baseline; gap: 5px; }
        .clock-ampm { font-size: 1.2rem; color: var(--neon-purple); font-weight: 600; }
        .clock-date { font-family: 'Outfit', sans-serif; font-size: 0.85rem; color: rgba(255, 255, 255, 0.5); letter-spacing: 2px; text-transform: uppercase; margin-top: 5px; }
        .brand { font-family: 'Rajdhani', sans-serif; font-size: 2.5rem; font-weight: 800; background: linear-gradient(90deg, var(--neon-blue), var(--neon-purple)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; filter: drop-shadow(0 0 15px rgba(0, 243, 255, 0.3)); letter-spacing: 5px; pointer-events: none; margin-bottom: 10px; }
        
        .search-container { width: 100%; display: flex; justify-content: center; z-index: 200; }
        .search-box { position: relative; width: 100%; max-width: 450px; background: rgba(0, 0, 0, 0.5); border: 1px solid var(--glass-border); border-radius: 50px; padding: 10px 20px 10px 25px; display: flex; align-items: center; transition: all 0.3s ease; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        .search-box:focus-within { background: rgba(0,0,0,0.9); border-color: var(--neon-blue); box-shadow: 0 0 25px rgba(0, 243, 255, 0.15); transform: scale(1.02); }
        .search-input { background: transparent; border: none; color: white; font-family: 'Rajdhani', sans-serif; font-size: 1.2rem; letter-spacing: 1px; width: 100%; font-weight: 500; user-select: text; -webkit-user-select: text; }
        .search-icon { color: var(--neon-purple); font-size: 1.2rem; margin-right: 15px; }
        .search-clear { background: transparent; border: none; color: var(--neon-blue); font-size: 1.2rem; cursor: pointer; padding: 5px; margin-left: 5px; display: none; align-items: center; justify-content: center; }

        .nav-btn { position: fixed; top: 30px; z-index: 9000; width: 45px; height: 45px; border-radius: 50%; font-size: 1.2rem; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s cubic-bezier(0.68, -0.55, 0.27, 1.55); backdrop-filter: blur(10px); box-shadow: 0 0 15px rgba(0,0,0,0.5); pointer-events: auto; touch-action: manipulation; }
        #btn-refresh { background: rgba(0,0,0,0.6); border: 2px solid var(--neon-blue); color: var(--neon-blue); right: 20px; }
        #btn-back { background: rgba(0,0,0,0.8); border: 2px solid var(--neon-purple); color: var(--neon-purple); right: -100px; opacity: 0; pointer-events: none; }
        #btn-back.show-btn { right: 20px; opacity: 1; pointer-events: auto; }

        .grid-container { display: grid; gap: 10px; padding-bottom: 20px; }
        .countries-mode { grid-template-columns: repeat(3, 1fr) !important; }
        .channels-mode { grid-template-columns: repeat(3, 1fr) !important; }
        .card { position: relative; border-radius: 12px; background: var(--glass); border: 1px solid var(--glass-border); cursor: pointer; transform-style: preserve-3d; opacity: 0; transform: translateY(20px); transition: transform 0.3s, border-color 0.3s; overflow: hidden; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        .card.show { animation: cardEntrance 0.5s forwards; }
        .aspect-rect { aspect-ratio: 16/10; } 
        .aspect-square { aspect-ratio: 1/1; }
        .card-inner { position: relative; width: 100%; height: 100%; pointer-events: none; }
        .card-img { width: 100%; height: 100%; object-fit: cover; transition: 0.5s; filter: brightness(0.9); }
        .card-img.channel-logo { object-fit: contain !important; transform: scale(0.9); background: rgba(0,0,0,0.3); }
        .card-title-bar { position: absolute; bottom: 0; left: 0; width: 100%; background: rgba(5, 5, 10, 0.95); border-top: 1px solid var(--neon-blue); padding: 4px 2px; z-index: 2; display: flex; align-items: center; justify-content: center; }
        .card-title { font-family: 'Rajdhani', sans-serif; font-size: 0.55rem; font-weight: 700; text-transform: uppercase; color: var(--neon-blue); text-align: center; letter-spacing: 1px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; width: 100%; }

        /* PLAYER MODAL */
        #player-modal { position: fixed; inset: 0; background: black; z-index: 10000; display: none; justify-content: center; align-items: center; animation: fadeIn 0.3s ease; }
        .video-container { width: 100%; max-width: 1200px; position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden; background: #000; box-shadow: 0 0 60px rgba(0, 243, 255, 0.08); border: 1px solid #333; display: flex; justify-content: center; align-items: center; }
        
        @media (orientation: landscape) {
            header, #grid, .fb-btn-container, #btn-refresh, #btn-back { display: none !important; }
            .close-player { display: none !important; }
            .video-container { position: fixed !important; top: 0 !important; left: 0 !important; width: 100vw !important; height: 100vh !important; max-width: none !important; padding-bottom: 0 !important; z-index: 99999 !important; background: black !important; display: flex !important; justify-content: center !important; align-items: center !important; }
            video, iframe { width: 100% !important; height: 100% !important; max-width: 100vw !important; max-height: 100vh !important; object-fit: contain !important; position: static !important; }
            #video-slot { position: static !important; width: 100% !important; height: 100% !important; display: flex; justify-content: center; align-items: center; }
        }

        #video-slot { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        video, iframe { width: 100%; height: 100%; position: absolute; top: 0; left: 0; border: none; display: block; }
        #click-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 20; display: none; }
        .controls-hidden #click-layer { display: block; }

        .pro-controls { position: absolute; bottom: 0; left: 0; right: 0; height: 60px; background: linear-gradient(to top, rgba(0,0,0,0.95), transparent); display: flex; align-items: center; justify-content: space-between; padding: 0 20px; opacity: 1; transition: opacity 0.5s ease; z-index: 2147483647; }
        .controls-hidden .pro-controls { opacity: 0; pointer-events: none; }
        .controls-left, .controls-right { display: flex; align-items: center; gap: 15px; }
        
        .icon-btn { background: none; border: none; cursor: pointer; color: rgba(255,255,255,0.85); width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; transition: 0.2s; }
        .icon-btn svg { width: 24px; height: 24px; fill: currentColor; }
        .live-badge { background: #cc0000; color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.7rem; font-weight: 700; margin-right: 10px; cursor: pointer; }
        .channel-info { font-size: 0.9rem; font-weight: 500; color: #ddd; }
        
        .close-player { position: absolute; top: 15px; right: 15px; z-index: 2147483647; background: rgba(0,0,0,0.5); width: 40px; height: 40px; border-radius: 50%; border: none; color: white; cursor: pointer; display: grid; place-items: center; opacity: 1; transition: opacity 0.5s ease; }
        .controls-hidden .close-player { opacity: 0; pointer-events: none; }

        /* BOTON CAST */
        .top-btn-container { position: absolute; top: 15px; right: 70px; display: flex; gap: 10px; z-index: 2147483647; }
        #btn-cast-native {
            background: rgba(0, 0, 0, 0.6); border: 1px solid var(--neon-blue); color: var(--neon-blue);
            width: 40px; height: 40px; border-radius: 50%; display: none; align-items: center; justify-content: center;
            opacity: 1; transition: opacity 0.5s ease, transform 0.2s; cursor: pointer;
            box-shadow: 0 0 10px rgba(0, 243, 255, 0.2);
        }
        #btn-cast-native:active { transform: scale(0.9); }
        #btn-cast-native svg { width: 20px; height: 20px; fill: currentColor; }
        .controls-hidden #btn-cast-native { opacity: 0; pointer-events: none; }
        #btn-cast-native.cast-connected { background: var(--neon-blue); color: black; box-shadow: 0 0 15px var(--neon-blue); }

        .fb-btn-container { width: 100%; display: flex; justify-content: center; margin-top: 30px; margin-bottom: 20px; padding-bottom: 20px; }
        .btn-facebook-stealth { width: 40px; height: 40px; background: rgba(255, 255, 255, 0.05); border-radius: 50%; display: flex; align-items: center; justify-content: center; text-decoration: none; transition: all 0.3s ease; backdrop-filter: blur(2px); border: 1px solid rgba(255, 255, 255, 0.05); }
        .btn-facebook-stealth svg { width: 20px; height: 20px; fill: rgba(255, 255, 255, 0.2); transition: 0.3s; }

        @keyframes logoReveal { 0% { opacity: 0; letter-spacing: 30px; filter: blur(20px); } 50% { opacity: 1; filter: blur(0px); } 100% { letter-spacing: 15px; } }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes cardEntrance { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body oncontextmenu="return false" ondragstart="return false" onselectstart="return false">

    <canvas id="bg-canvas"></canvas>

    <div id="splash">
        <h1 class="splash-logo">NEXUS</h1>
        <p class="splash-sub">Centroamérica Conectada</p>
    </div>

    <button id="btn-refresh" class="nav-btn" onmousedown="event.preventDefault(); sound('click'); location.reload()">↻</button>
    <button id="btn-back" class="nav-btn" onmousedown="event.preventDefault(); goBackSystem()">❮</button>

    <div id="app">
        <header>
            <div class="digital-clock-container">
                <div class="clock-time-wrapper"><span id="clock-time">00:00</span><span id="clock-ampm" class="clock-ampm">AM</span></div>
                <div id="clock-date" class="clock-date">Cargando...</div>
            </div>
            <div class="brand">NEXUS</div>
            <div class="search-container">
                <div class="search-box">
                    <span class="search-icon">⌕</span>
                    <input type="text" id="search-input" class="search-input" placeholder="BUSCAR..." autocomplete="off">
                    <button class="search-clear" id="btn-clear-search" onmousedown="event.preventDefault(); clearSearch()">✕</button>
                </div>
            </div>
        </header>

        <h3 id="section-title" style="margin-bottom: 20px; text-align: center; font-weight: 300; opacity: 0.8; letter-spacing: 2px;">EXPLORAR REGIONES</h3>
        <div id="grid" class="grid-container countries-mode"></div>

        <div class="fb-btn-container">
            <a href="https://www.facebook.com" target="_blank" class="btn-facebook-stealth" onclick="sound('click')">
                <svg viewBox="0 0 24 24"><path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/></svg>
            </a>
        </div>
    </div>

    <div id="player-modal">
        <div class="video-container" id="vid-container" onmousemove="resetControlsTimer()">
            <div id="click-layer" onclick="resetControlsTimer()"></div>
            <button class="close-player" onclick="smartClose()">✕</button>
            
            <div class="top-btn-container">
                <button id="btn-cast-native" onclick="handleCastClick()">
                    <svg viewBox="0 0 24 24">
                        <path d="M1 18v3h3c0-1.66-1.34-3-3-3zm0-4v2c2.76 0 5 2.24 5 5h2c0-3.87-3.13-7-7-7zm0-4v2c4.97 0 9 4.03 9 9h2c0-6.08-4.93-11-11-11zm9 5.86V6h9.14v12h-5.29c.15.65.23 1.32.23 2h5.92c.55 0 1-.45 1-1V5c0-.55-.45-1-1-1h-11c-.55 0-1 .45-1 1v5.86z"/>
                    </svg>
                </button>
            </div>

            <div id="video-slot"></div>
            
            <div class="pro-controls" id="controls">
                <div class="controls-left">
                    <button class="icon-btn" onclick="togglePlay()" id="btn-play"><svg viewBox="0 0 24 24"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg></button>
                    <button class="icon-btn" onclick="toggleMute()" id="btn-mute"><svg viewBox="0 0 24 24"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02z"/></svg></button>
                    <div class="live-badge" onclick="sound('click'); refreshStream();">EN VIVO</div>
                    <span class="channel-info" id="playing-name">Canal</span>
                </div>
                <div class="controls-right"><button class="icon-btn" onclick="toggleFullScreen()"><svg viewBox="0 0 24 24"><path d="M7 14H5v5h5v-2H7v-3zm-2-4h2V7h3V5H5v5zm12 7h-3v2h5v-5h-2v3zM14 5v2h3v3h2V5h-5z"/></svg></button></div>
            </div>
        </div>
    </div>

    <script>
        /* TUS DATOS ORIGINALES RESTAURADOS */
        const DATA = [
            { id: 'gt', name: 'HONDURAS', img: 'Honduras.jpg', channels: [
                { name: 'CANAL 10', img: 'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQpDGlXC04QvxP1Y__Sas5hW2iXoSDiPwCdcP1AuKneTQ&s=10', url: 'https://gavamultimedios.com/CHTV/index.php' },
                { name: 'CANAL 11', img: 'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQfLY40-OiueBodErw2tgVrSCuwVxJqHFAM-pmCUYcs9Q&s=10', url: 'https://redirector.rudo.video/hls-video/c54ac2799874375c81c1672abb700870537c5223/canal11hn/canal11hn.smil/playlist.m3u8?did=b2141583316068ca2593ea08a' },
                { name: 'METRO TV', img: 'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSgu9VRA7NBDrkAuMghiTBdr4kQ-m0IqlSwtr2uXXuOqg&s=10', url: 'https://s.emisoras.tv:8081/metrotv/index.m3u8' },
                { name: 'ALSIASTV', img: 'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSu3z5fYrtvbiB8i-lxiEppQikxSPNEczB9KuJzjKsx0w&s=10', url: 'https://s.emisoras.tv:8081/atv/index.m3u8' },
                { name: 'CHTV', img: 'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQTCAzJqUQv6nwDUjO55eA7YozKd3MQW7DDGmAm64UFUw&s=10', url: 'https://gavamultimedios.com/CHTV/index.php' },
                { name: 'GLOBO TV', img: 'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQ3Ss5zZk5tt4Ha0ZMRlPd-bnHoCe0zNRhuehlZWCFd8w&s=10', url: 'https://stream.radiosmundiales.com:19360/globotvhonduras/globotvhonduras.m3u8' },
                { name: 'CHOLUTECA TV', img: 'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcRNlNgKgoSJ-bI6cZKgPOdwGOwnSBNH8xTtXxX6F5HR5Q&s=10', url: 'https://s.emisoras.tv:8081/cholutecatv/tracks-v1a1/mono.m3u8' },
                { name: 'CCI CHANEL', img: 'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcT6kzMd1GA8zRn5KJP9Xgw9mvSw0Z5hO6Yp-cRsea_OJg&s=10', url: 'https://livestream.mediacci.com/ccitv/index.m3u8' },
                { name: 'TELEPAIS', img: 'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSiZVUlOwz9fTXnRS-Ts3qpQOmaRYnq9Cgds-zUuQp1ag&s=10', url: 'https://tv.webmedialive.com/teleprogreso/live/playlist.m3u8' },
                { name: 'MAYA TV', img: 'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9Qq_snbA1tvxR8TzgGB9ZDH0ng2Zo86_JaM4X0wcgw_3g&s=10', url: 'https://media.streambrothers.com:2000/VideoPlayer/8036?autoplay=1' },
                { name: 'CANAL 6', img: 'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSP6Ur33Sa1BaD4V3bz09epypIbsWoBpKSWIJECAtkGyA&s=10', url: 'https://envivo.canal6.com.hn/memfs/5a536b3e-954a-4124-a17a-d94bbd0968a2.m3u8' },
                { name: 'CANAL 8', img: 'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcRoeHXu4LKB2GaPvjgznFr3pzFWkuSMa5q1muNxQp98vw&s=10', url: 'https://cdn2.castx.live:2020/VideoPlayer/canal8?autoplay=1' },
                { name: 'ACTIVA TV', img: 'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcST5iy5laXTHQqUgypvy2MtCmA5l7WWSQ-6SETokdzIag&s=10', url: 'https://teleon.tv/embed/NGYzYzJhNDgyOTM0ZjNjMmEAOF/' },
                { name: 'CAMPUS TV', img: 'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSdU1fKOl00rVbjLqVPxhr4rpOmNLyyxAkiRg&s', url: 'https://5e85d90130e77.streamlock.net/6052/6052/playlist.m3u8' },
                { name: 'EDN TV', img: 'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcTZ0CVR0ByhSLbg5j_z8Mzzwv5bZ_bo7FczbfEXYHQzWg&s=10', url: 'https://5fe2654d6127d.streamlock.net/edntv/videoedntv/chunklist_w1100275423.m3u8' }
            ]},
            { id: 'mx', name: 'MEXICO', img: 'https://s1.significados.com/foto/bandera-de-mexico-og.jpg?class=ogImageSquare', channels: [] },
            { id: 'sv', name: 'El Salvador', img: 'https://images.unsplash.com/photo-1627920769919-482065979207?w=400&q=80', channels: [] },
            { id: 'cr', name: 'Costa Rica', img: 'https://images.unsplash.com/photo-1518182170546-0766ce6fec56?w=400&q=80', channels: [] },
            { id: 'ni', name: 'Nicaragua', img: 'https://images.unsplash.com/photo-1569408016462-113c23315a63?w=400&q=80', channels: [] },
            { id: 'pa', name: 'Panamá', img: 'https://images.unsplash.com/photo-1502307134371-d6402432a51a?w=400&q=80', channels: [] }
        ];

        let appState = 'HOME', currentCountry = null, currentChannel = null, hls = null, controlsTimeout, searchTimeout;
        const SFX = { click: new Audio('https://assets.mixkit.co/active_storage/sfx/2571/2571-preview.mp3'), select: new Audio('https://assets.mixkit.co/active_storage/sfx/2568/2568-preview.mp3'), back: new Audio('https://assets.mixkit.co/active_storage/sfx/2572/2572-preview.mp3') };
        function sound(type) { if(SFX[type]) { const s = SFX[type].cloneNode(); s.volume = 0.5; s.play().catch(()=>{}); } }

        /* --- LOGICA DEL BOTON "INTELIGENTE" --- */
        let castContext = null;
        let castSession = null;

        window['__onGCastApiAvailable'] = function(isAvailable) {
            if (isAvailable) {
                initializeCastApi();
            }
        };

        function initializeCastApi() {
            cast.framework.CastContext.getInstance().setOptions({
                receiverApplicationId: chrome.cast.media.DEFAULT_MEDIA_RECEIVER_APP_ID,
                autoJoinPolicy: chrome.cast.AutoJoinPolicy.ORIGIN_SCOPED
            });
            castContext = cast.framework.CastContext.getInstance();
            castContext.addEventListener(
                cast.framework.CastContextEventType.SESSION_STATE_CHANGED,
                function(event) {
                    switch (event.sessionState) {
                        case cast.framework.SessionState.SESSION_STARTED:
                        case cast.framework.SessionState.SESSION_RESUMED:
                            castSession = castContext.getCurrentSession();
                            updateCastButtonState(true);
                            if(currentChannel) smartLoadMediaOnCast(currentChannel);
                            break;
                        case cast.framework.SessionState.SESSION_ENDED:
                            castSession = null;
                            updateCastButtonState(false);
                            break;
                    }
                }
            );
        }

        function handleCastClick() {
            sound('click');
            if (castContext) {
                castContext.requestSession().then(
                    function(error) { if (error) console.log('Error solicitando sesión:', error); }
                );
            } else {
                alert("Transmitir no disponible. Asegúrate de estar en WiFi.");
            }
        }

        function updateCastButtonState(isConnected) {
            const btn = document.getElementById('btn-cast-native');
            if(isConnected) btn.classList.add('cast-connected');
            else btn.classList.remove('cast-connected');
        }

        /* AQUÍ ESTÁ LA MAGIA: DETECTA QUÉ TIPO ES Y ACTÚA DIFERENTE */
        function smartLoadMediaOnCast(channel) {
            if (!castSession) return;
            
            const url = channel.url;
            const title = channel.name;
            
            let mediaInfo;

            // 1. SI ES VIDEO (M3U8) -> LO TRATAMOS COMO VIDEO (FUNCIONA BIEN)
            if (url.includes('.m3u8')) {
                console.log("Enviando como VIDEO STREAMING");
                mediaInfo = new chrome.cast.media.MediaInfo(url, 'application/x-mpegurl');
                mediaInfo.streamType = chrome.cast.media.StreamType.LIVE;
            } 
            // 2. SI ES IFRAME/WEB -> ENVIAMOS LA ORDEN DE ABRIR ENLACE (PARA EVITAR PANTALLA AZUL)
            else {
                console.log("Enviando como ENLACE WEB");
                // Usamos 'text/html' para que el TV sepa que no es un video para cargar en buffer.
                // Esto evita que se quede cargando infinitamente (pantalla azul).
                mediaInfo = new chrome.cast.media.MediaInfo(url, 'text/html');
                mediaInfo.streamType = chrome.cast.media.StreamType.BUFFERED; 
            }

            // Metadatos comunes
            mediaInfo.metadata = new chrome.cast.media.GenericMediaMetadata();
            mediaInfo.metadata.metadataType = chrome.cast.media.MetadataType.GENERIC;
            mediaInfo.metadata.title = title;
            mediaInfo.metadata.images = [{url: 'https://cdn-icons-png.flaticon.com/512/777/777242.png'}];

            var request = new chrome.cast.media.LoadRequest(mediaInfo);
            castSession.loadMedia(request).then(
                function() { console.log('Solicitud enviada al TV'); },
                function(errorCode) { console.log('Error de envío: ' + errorCode); }
            );
        }

        /* --- APP LOGIC --- */
        window.onload = () => {
            updateClock(); setInterval(updateClock, 1000);
            history.replaceState({view: 'home'}, '', '');
            setTimeout(() => { document.getElementById('splash').classList.add('hidden'); document.getElementById('app').classList.add('visible'); renderCountriesVisuals(); }, 3000); 
        };

        function updateClock() {
            const now = new Date();
            let h = now.getHours(); const m = String(now.getMinutes()).padStart(2, '0'); const ampm = h >= 12 ? 'PM' : 'AM';
            h = h % 12 || 12;
            document.getElementById('clock-time').textContent = `${h}:${m}`;
            document.getElementById('clock-ampm').textContent = ampm;
            document.getElementById('clock-date').textContent = now.toLocaleDateString('es-ES', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
        }

        window.onpopstate = function(event) {
            if (event.state) {
                if (event.state.view === 'home') { closePlayerVisuals(); renderCountriesVisuals(); } 
                else if (event.state.view === 'channels') { closePlayerVisuals(); renderChannelsVisuals(event.state.country); }
                else if (event.state.view === 'player') { openPlayerVisuals(event.state.channel); }
            } else { closePlayerVisuals(); renderCountriesVisuals(); }
        };

        function renderCountriesVisuals(d = DATA) {
            currentCountry = null; appState = 'HOME';
            const grid = document.getElementById('grid');
            grid.className = 'grid-container countries-mode'; grid.innerHTML = ''; 
            document.getElementById('section-title').innerText = 'EXPLORAR REGIONES'; 
            document.getElementById('btn-back').classList.remove('show-btn'); 
            d.forEach((c, i) => { 
                const el = createCard(c.name, c.img, 'aspect-rect', i, false); 
                el.onclick = () => { 
                    sound('select');
                    history.pushState({view: 'channels', country: c}, '', '');
                    renderChannelsVisuals(c); 
                }; 
                grid.appendChild(el); 
            });
        }

        function renderChannelsVisuals(country, d = null) {
            currentCountry = country; appState = 'CHANNELS';
            const channels = d || country.channels;
            const grid = document.getElementById('grid');
            grid.innerHTML = ''; grid.className = 'grid-container channels-mode'; 
            document.getElementById('section-title').innerText = country.name; 
            document.getElementById('btn-back').classList.add('show-btn'); 
            channels.forEach((c, i) => { 
                const el = createCard(c.name, c.img, 'aspect-square', i, true); 
                el.onclick = () => { 
                    sound('select'); 
                    history.pushState({view: 'player', channel: c}, '', '');
                    openPlayerVisuals(c); 
                }; 
                grid.appendChild(el); 
            });
        }

        function createCard(txt, img, ratio, index, isChannel) {
            const d = document.createElement('div'); d.className = `card ${ratio}`;
            const imgClass = isChannel ? "card-img channel-logo" : "card-img";
            d.innerHTML = `<div class="card-inner"><img src="${img}" class="${imgClass}" loading="lazy"><div class="card-title-bar"><div class="card-title">${txt}</div></div></div>`;
            setTimeout(() => d.classList.add('show'), 10);
            return d;
        }

        function openPlayerVisuals(c) {
            currentChannel = c; appState = 'PLAYER';
            document.body.classList.add('player-active');
            const p = document.getElementById('player-modal'); const s = document.getElementById('video-slot'); const ctrls = document.getElementById('controls');
            
            const btnCast = document.getElementById('btn-cast-native');
            btnCast.style.display = 'flex';

            document.getElementById('playing-name').innerText = c.name; p.style.display = 'flex'; s.innerHTML = '';
            resetControlsTimer();
            
            // Si ya hay sesión, actualizamos en TV con la lógica inteligente
            if (castSession) {
                smartLoadMediaOnCast(c);
            }

            // Lógica LOCAL (Pantalla del Celular)
            if(c.url.includes('.m3u8')) {
                ctrls.style.display = 'flex'; 
                const v = document.createElement('video'); v.id = 'vid'; v.autoplay = true; s.appendChild(v);
                if(Hls.isSupported()) { hls = new Hls(); hls.loadSource(c.url); hls.attachMedia(v); } 
            } else {
                // Iframe local
                ctrls.style.display = 'none'; 
                s.innerHTML = `<iframe src="${c.url}" allowfullscreen></iframe>`; 
            }
        }

        const normalizeText = (text) => text.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase();
        document.getElementById('search-input').addEventListener('input', (e) => {
            const val = e.target.value;
            document.getElementById('btn-clear-search').style.display = val.length > 0 ? 'flex' : 'none';
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                const normVal = normalizeText(val);
                if(appState === 'HOME') renderCountriesVisuals(DATA.filter(c => normalizeText(c.name).includes(normVal))); 
                else if (appState === 'CHANNELS' && currentCountry) renderChannelsVisuals(currentCountry, currentCountry.channels.filter(c => normalizeText(c.name).includes(normVal))); 
            }, 300); 
        });

        function clearSearch() { document.getElementById('search-input').value = ''; document.getElementById('search-input').dispatchEvent(new Event('input')); }

        function goBackSystem() { sound('back'); if(appState === 'PLAYER') smartClose(); else if(appState === 'CHANNELS') renderCountriesVisuals(); else history.back(); }

        async function smartClose() { if (document.fullscreenElement) await document.exitFullscreen(); history.back(); }

        function closePlayerVisuals() {
            document.body.classList.remove('player-active');
            document.getElementById('player-modal').style.display = 'none'; 
            document.getElementById('video-slot').innerHTML = ''; 
            document.getElementById('btn-cast-native').style.display = 'none';
            if(hls) { hls.destroy(); hls = null; }
        }

        function resetControlsTimer() {
            const container = document.querySelector('.video-container');
            container.classList.remove('controls-hidden');
            clearTimeout(controlsTimeout);
            controlsTimeout = setTimeout(() => { container.classList.add('controls-hidden'); }, 3000);
        }
        
        function togglePlay() { const v = document.getElementById('vid'); if(v) { v.paused ? v.play() : v.pause(); sound('click'); }}
        function toggleMute() { const v = document.getElementById('vid'); if(v) { v.muted = !v.muted; sound('click'); }}
        function toggleFullScreen() {
             const c = document.getElementById('vid-container');
             if (!document.fullscreenElement) c.requestFullscreen().catch(err => console.log(err));
             else document.exitFullscreen();
        }
        function refreshStream() {
             if(hls && currentChannel) {
                 hls.destroy();
                 const v = document.getElementById('vid');
                 hls = new Hls(); hls.loadSource(currentChannel.url); hls.attachMedia(v);
                 v.play();
             } else if (currentChannel) {
                 const s = document.getElementById('video-slot');
                 s.innerHTML = s.innerHTML; 
             }
        }

        const canvas = document.getElementById('bg-canvas'); const ctx = canvas.getContext('2d'); let parts = [];
        const resize = () => { canvas.width = innerWidth; canvas.height = innerHeight; }; window.onresize = resize; resize();
        class P { constructor() { this.r(); } r() { this.x=Math.random()*canvas.width; this.y=Math.random()*canvas.height; this.vx=(Math.random()-.5)*.5; this.vy=(Math.random()-.5)*.5; } u() { this.x+=this.vx; this.y+=this.vy; if(this.x<0||this.x>canvas.width)this.vx*=-1; if(this.y<0||this.y>canvas.height)this.vy*=-1; } d() { ctx.fillStyle='rgba(0,243,255,0.2)'; ctx.beginPath(); ctx.arc(this.x,this.y,1,0,Math.PI*2); ctx.fill(); } }
        for(let i=0;i<60;i++) parts.push(new P());
        function anim() { ctx.clearRect(0,0,canvas.width,canvas.height); parts.forEach(p=>{p.u();p.d();}); requestAnimationFrame(anim); }
        anim();
    </script>
</body>
</html>
